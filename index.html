<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Smart Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .card { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        input:focus { outline: none; }
        .nav-item.active svg, .nav-item.active span { color: #4f46e5; }
        header { padding-top: env(safe-area-inset-top); }
        nav { padding-bottom: env(safe-area-inset-bottom); }
        .spinner { border-top-color: transparent; }
        main { flex: 1 1 0; }
        .star-rating svg { cursor: pointer; }
        .star-rating .star-filled { color: #f59e0b; }
        .star-rating .star-empty { color: #d1d5db; }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Login Page -->
    <div id="login-page" class="flex flex-col items-center justify-center h-screen bg-gray-100 p-4">
        <div class="w-full max-w-sm bg-white p-8 rounded-2xl shadow-lg">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                    Smart Library
                </h1>
                <p class="text-gray-500 mt-2">Please sign in to continue.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="roll-no-input" class="block text-sm font-medium text-gray-700">University Roll No.</label>
                    <input type="text" id="roll-no-input" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label for="password-input" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password-input" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
            <p id="login-error" class="text-red-500 text-sm mt-2 text-center h-4"></p>
            <button id="login-btn" class="mt-4 w-full bg-indigo-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-indigo-700 transition flex items-center justify-center" disabled>
                <span id="login-btn-text">Initializing...</span>
                <div id="login-spinner" class="spinner animate-spin rounded-full h-5 w-5 border-2 border-white hidden ml-2"></div>
            </button>
            <div class="text-center mt-4">
                <a href="#" id="forgot-password-link" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">Forgot Password?</a>
            </div>
        </div>
    </div>
    
    <!-- Main App Content -->
    <div id="main-app" class="hidden h-screen">
        <div class="flex flex-col h-full justify-between">
            <main class="overflow-y-auto pb-20">
                <div id="library-page">
                     <header class="bg-white shadow-sm sticky top-0 z-20">
                        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
                            <h1 id="page-title" class="text-2xl font-bold text-gray-900 flex items-center"></h1>
                            <div id="search-container" class="mt-4">
                                <input type="text" id="search-input" placeholder="Search all books..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                    </header>
                    <div id="library-content" class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 px-4"></div>
                </div>
                <div id="wishlist-page" class="hidden">
                     <header class="bg-white shadow-sm sticky top-0 z-20">
                        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8"><h1 class="text-2xl font-bold text-gray-900 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                            My Wishlist</h1></div>
                    </header>
                    <div id="wishlist-content" class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 px-4"></div>
                </div>
                 <div id="demands-page" class="hidden">
                    <header class="bg-white shadow-sm sticky top-0 z-20">
                        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8"><h1 class="text-2xl font-bold text-gray-900 flex items-center">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                           Book Demands</h1></div>
                    </header>
                    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 px-4 space-y-6">
                        <div class="bg-white p-4 rounded-lg shadow">
                            <h2 class="font-semibold mb-2">Demand a New Book</h2>
                            <div class="space-y-2">
                                <input type="text" id="demand-title" placeholder="Book Title" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <input type="text" id="demand-author" placeholder="Author" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <button id="demand-submit-btn" class="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg hover:bg-indigo-700 transition">Submit Demand</button>
                            </div>
                        </div>
                        <div id="demands-content" class="space-y-3"></div>
                    </div>
                </div>
                <div id="academics-page" class="hidden">
                    <header class="bg-white shadow-sm sticky top-0 z-20">
                        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8"><h1 class="text-2xl font-bold text-gray-900 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 14l9-5-9-5-9 5 9 5z" /><path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0112 20.055a11.952 11.952 0 01-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0112 20.055a11.952 11.952 0 01-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222 4 2.222V20M12 14.75L2 10l10-5.25L22 10l-10 4.75z" /></svg>
                            Academic Resources</h1></div>
                    </header>
                    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 px-4 space-y-4">
                        <div id="academics-research-card" class="card bg-white rounded-lg p-4 flex justify-between items-center cursor-pointer">
                            <h3 class="font-semibold text-gray-800">Research Papers</h3>
                            <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </div>
                        <div id="academics-qpapers-card" class="card bg-white rounded-lg p-4 flex justify-between items-center cursor-pointer">
                            <h3 class="font-semibold text-gray-800">Question Papers</h3>
                            <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </div>
                    </div>
                </div>
                <div id="research-page" class="hidden">
                    <header class="bg-white shadow-sm sticky top-0 z-20">
                        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
                            <button id="back-to-academics-btn-1" class="text-indigo-600 font-semibold mb-4 flex items-center"><svg class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg> Back</button>
                            <h1 class="text-2xl font-bold text-gray-900 flex items-center">Research Papers</h1>
                             <div class="mt-4">
                                <input type="search" id="research-search-input" placeholder="Search by title or author..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>
                    </header>
                    <div id="research-content" class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 px-4"></div>
                </div>
                <div id="qpapers-page" class="hidden">
                    <header class="bg-white shadow-sm sticky top-0 z-20">
                        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
                            <button id="back-to-academics-btn-2" class="text-indigo-600 font-semibold mb-4 flex items-center"><svg class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg> Back</button>
                            <h1 class="text-2xl font-bold text-gray-900 flex items-center">Question Papers</h1></div>
                    </header>
                    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 px-4 space-y-6">
                        <div class="bg-white p-4 rounded-lg shadow space-y-4">
                            <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                                <div>
                                    <label for="filter-department" class="block text-sm font-medium text-gray-700">Department</label>
                                    <select id="filter-department" class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3 bg-white">
                                        <option value="">All</option><option>CSE</option><option>ECE</option><option>ME</option><option>CE</option><option>Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="filter-year" class="block text-sm font-medium text-gray-700">Year</label>
                                    <select id="filter-year" class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3 bg-white">
                                        <option value="">All</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="filter-semester" class="block text-sm font-medium text-gray-700">Semester</label>
                                     <select id="filter-semester" class="mt-1 block w-full border border-gray-300 rounded-md py-2 px-3 bg-white">
                                        <option value="">All</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option>
                                    </select>
                                </div>
                                <div class="self-end">
                                    <button id="filter-qpapers-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Find</button>
                                </div>
                            </div>
                        </div>
                        <div id="qpapers-content" class="space-y-3"></div>
                    </div>
                </div>
                <div id="profile-page" class="hidden">
                     <header class="bg-white shadow-sm sticky top-0 z-20">
                        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-gray-900 flex items-center">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                 My Profile</h1>
                             <button id="logout-btn" class="text-sm font-medium text-indigo-600 hover:text-indigo-800">Logout</button>
                        </div>
                    </header>
                    <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 px-4 space-y-6">
                        <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center text-center">
                            <img id="profile-avatar" class="h-24 w-24 rounded-full object-cover mb-4 shadow-md" src="">
                            <h2 id="profile-name" class="text-xl font-bold text-gray-800"></h2>
                            <p id="profile-rollno" class="text-gray-500"></p>
                            <div class="mt-6 border-t pt-6 w-full flex flex-col items-center">
                                <h3 class="text-lg font-semibold text-gray-700 mb-2">Library Card</h3>
                                <div class="bg-gray-100 p-4 rounded-lg"><canvas id="qr-code-canvas"></canvas></div>
                                <p class="text-xs text-gray-400 mt-2">Scan this QR code to issue books.</p>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">Change Password</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="current-password-input" class="block text-sm font-medium text-gray-700">Current Password</label>
                                    <input type="password" id="current-password-input" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label for="new-password-input" class="block text-sm font-medium text-gray-700">New Password</label>
                                    <input type="password" id="new-password-input" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                            <p id="password-change-status" class="text-sm mt-2 text-center h-4"></p>
                            <button id="change-password-btn" class="mt-4 w-full bg-indigo-600 text-white font-bold py-2.5 px-4 rounded-lg hover:bg-indigo-700">Update Password</button>
                        </div>
                    </div>
                </div>
            </main>
            
            <nav class="bg-white shadow-t w-full fixed bottom-0 border-t">
                <div class="max-w-7xl mx-auto flex justify-around py-2 px-4">
                    <button id="nav-library" class="nav-item flex flex-col items-center text-gray-500 active">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                        <span class="text-xs font-medium">Library</span>
                    </button>
                    <button id="nav-wishlist" class="nav-item flex flex-col items-center text-gray-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                        <span class="text-xs font-medium">Wishlist</span>
                    </button>
                    <button id="nav-demands" class="nav-item flex flex-col items-center text-gray-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                        <span class="text-xs font-medium">Demands</span>
                    </button>
                     <button id="nav-academics" class="nav-item flex flex-col items-center text-gray-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 14l9-5-9-5-9 5 9 5z" /><path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0112 20.055a11.952 11.952 0 01-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5zm0 0l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0112 20.055a11.952 11.952 0 01-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14zm-4 6v-7.5l4-2.222 4 2.222V20M12 14.75L2 10l10-5.25L22 10l-10 4.75z" /></svg>
                        <span class="text-xs font-medium">Academics</span>
                    </button>
                    <button id="nav-profile" class="nav-item flex flex-col items-center text-gray-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        <span class="text-xs font-medium">Profile</span>
                    </button>
                </div>
            </nav>
        </div>
    </div>
    
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 opacity-0 pointer-events-none z-50">
       <div id="modal-content" class="bg-white w-full max-w-md rounded-2xl shadow-xl relative flex flex-col max-h-[90vh]">
            <button id="close-modal" class="absolute top-3 right-3 text-gray-400 hover:text-gray-700 z-10"><svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
            <div class="p-6">
                <div class="flex items-start space-x-4">
                    <img id="modal-thumbnail" src="" class="w-24 h-36 object-cover rounded-md shadow-lg flex-shrink-0">
                    <div class="flex-1">
                        <h2 id="modal-title" class="text-2xl font-bold text-gray-800 mb-1"></h2>
                        <p id="modal-author" class="text-md text-gray-500 mb-2"></p>
                        <div id="modal-avg-rating" class="flex items-center text-sm text-gray-500 mb-2"></div>
                        <p id="modal-status" class="text-sm font-semibold mb-4 inline-block px-3 py-1 rounded-full"></p>
                    </div>
                </div>
                <button id="wishlist-btn" class="w-full text-white font-bold py-2 rounded-lg mt-4 transition"></button>
            </div>
            <div class="px-6 border-t border-b overflow-y-auto flex-1">
                <h3 class="text-lg font-semibold text-gray-800 pt-4 pb-2 sticky top-0 bg-white">Reviews</h3>
                <div id="modal-reviews-list" class="space-y-4 pb-4"></div>
            </div>
            <div class="p-6 bg-gray-50 rounded-b-2xl">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Leave a Review</h3>
                <div id="add-review-form">
                    <div class="star-rating flex items-center mb-2" data-rating="0"></div>
                    <textarea id="review-comment" class="w-full border border-gray-300 rounded-lg p-2 h-20" placeholder="Share your thoughts..."></textarea>
                    <button id="submit-review-btn" class="w-full bg-indigo-600 text-white font-bold py-2 rounded-lg mt-2 hover:bg-indigo-700 transition">Submit Review</button>
                    <p id="review-error" class="text-red-500 text-sm mt-1 text-center h-4"></p>
                </div>
            </div>
       </div>
    </div>
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, setDoc, deleteDoc, updateDoc, increment, query, where, orderBy, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- All variables, selectors, and initialization logic ---
        const firebaseConfig = {
            apiKey: "AIzaSyDB9oY6IJciaFp1THAJ0VeI7rpSrefj5sk",
            authDomain: "smartlibrary-e03f7.firebaseapp.com",
            projectId: "smartlibrary-e03f7",
            storageBucket: "smartlibrary-e03f7.appspot.com",
            messagingSenderId: "524474984955",
            appId: "1:524474984955:web:4cb81fb71499be9425835e"
        };
        let db;
        let allShelves = [], allBooks = [], allDemands = [], myWishlistBooks = [], myHistory = [], allResearchPapers = [];
        let currentUser = null;
        let listeners = { library: null, wishlist: null, demands: null, history: null, research: null };
        let currentOpenBookId = null;
        const pages = {
            login: document.getElementById('login-page'), main: document.getElementById('main-app'), library: document.getElementById('library-page'),
            wishlist: document.getElementById('wishlist-page'), demands: document.getElementById('demands-page'), 
            academics: document.getElementById('academics-page'), research: document.getElementById('research-page'),
            qpapers: document.getElementById('qpapers-page'), history: document.getElementById('history-page'),
            profile: document.getElementById('profile-page')
        };
        const navItems = {
            library: document.getElementById('nav-library'), wishlist: document.getElementById('nav-wishlist'),
            demands: document.getElementById('nav-demands'), academics: document.getElementById('nav-academics'),
            history: document.getElementById('nav-history'), profile: document.getElementById('nav-profile')
        };
        const dom = {
            rollNoInput: document.getElementById('roll-no-input'), passwordInput: document.getElementById('password-input'),
            loginBtn: document.getElementById('login-btn'), loginBtnText: document.getElementById('login-btn-text'),
            loginSpinner: document.getElementById('login-spinner'), loginError: document.getElementById('login-error'),
            logoutBtn: document.getElementById('logout-btn'), forgotPasswordLink: document.getElementById('forgot-password-link'),
            libraryContent: document.getElementById('library-content'), wishlistContent: document.getElementById('wishlist-content'),
            demandsContent: document.getElementById('demands-content'), historyContent: document.getElementById('history-content'),
            pageTitle: document.getElementById('page-title'), searchInput: document.getElementById('search-input'), 
            profileAvatar: document.getElementById('profile-avatar'), profileName: document.getElementById('profile-name'), 
            profileRollNo: document.getElementById('profile-rollno'), qrCodeCanvas: document.getElementById('qr-code-canvas'),
            demandTitleInput: document.getElementById('demand-title'), demandAuthorInput: document.getElementById('demand-author'),
            demandSubmitBtn: document.getElementById('demand-submit-btn'), toast: document.getElementById('toast'),
            modal: document.getElementById('modal'), modalContent: document.getElementById('modal-content'), 
            modalTitle: document.getElementById('modal-title'), modalAuthor: document.getElementById('modal-author'), 
            modalStatus: document.getElementById('modal-status'), modalThumbnail: document.getElementById('modal-thumbnail'),
            wishlistBtn: document.getElementById('wishlist-btn'), closeModalBtn: document.getElementById('close-modal'),
            currentPasswordInput: document.getElementById('current-password-input'), newPasswordInput: document.getElementById('new-password-input'),
            changePasswordBtn: document.getElementById('change-password-btn'), passwordChangeStatus: document.getElementById('password-change-status'),
            modalAvgRating: document.getElementById('modal-avg-rating'), modalReviewsList: document.getElementById('modal-reviews-list'),
            addReviewForm: document.getElementById('add-review-form'), reviewComment: document.getElementById('review-comment'),
            submitReviewBtn: document.getElementById('submit-review-btn'), reviewError: document.getElementById('review-error'),
            researchContent: document.getElementById('research-content'), qpapersContent: document.getElementById('qpapers-content'),
            filterDepartment: document.getElementById('filter-department'), filterYear: document.getElementById('filter-year'),
            filterSemester: document.getElementById('filter-semester'), filterQpapersBtn: document.getElementById('filter-qpapers-btn'),
            researchSearchInput: document.getElementById('research-search-input'),
            academicsResearchCard: document.getElementById('academics-research-card'),
            academicsQpapersCard: document.getElementById('academics-qpapers-card'),
            backToAcademicsBtn1: document.getElementById('back-to-academics-btn-1'),
            backToAcademicsBtn2: document.getElementById('back-to-academics-btn-2'),
        };

        // --- App Initialization ---
        try { 
            const app = initializeApp(firebaseConfig); 
            db = getFirestore(app); 
            checkLoginState();
        } catch (e) { 
            console.error("Firebase Init Error:", e);
            document.body.innerHTML = `<p class="text-red-500 text-center py-10">Error initializing app.</p>`; 
        }

        // --- Core App Flow ---
        function setLoginButtonLoading(isLoading) {
            dom.loginBtn.disabled = isLoading;
            dom.loginBtnText.classList.toggle('hidden', isLoading);
            dom.loginSpinner.classList.toggle('hidden', !isLoading);
        }
        function showApp() { 
            pages.login.classList.add('hidden'); 
            pages.main.classList.remove('hidden'); 
            showPage('library'); 
        }
        function showLogin() {
            pages.main.classList.add('hidden');
            pages.login.classList.remove('hidden');
            currentUser = null;
            localStorage.removeItem('loggedInStudentRollNo');
            Object.values(listeners).forEach(unsubscribe => unsubscribe && unsubscribe());
            listeners = { library: null, wishlist: null, demands: null, history: null, research: null };
        }
        async function checkLoginState() {
            const loggedInRollNo = localStorage.getItem('loggedInStudentRollNo');
            if (loggedInRollNo) {
                try {
                    const userDoc = await getDoc(doc(db, "students", loggedInRollNo));
                    if (userDoc.exists()) { 
                        currentUser = { rollNo: userDoc.id, ...userDoc.data() }; 
                        showApp(); 
                    } else { showLogin(); }
                } catch (e) { showLogin(); }
            } else {
                setLoginButtonLoading(false);
                dom.loginBtnText.textContent = 'Login';
                showLogin();
            }
        }
        dom.loginBtn.addEventListener('click', async () => {
             setLoginButtonLoading(true);
            const rollNo = dom.rollNoInput.value.trim();
            const password = dom.passwordInput.value.trim();
            dom.loginError.textContent = '';
            if (!rollNo || !password) {
                dom.loginError.textContent = 'Please fill all fields.';
                setLoginButtonLoading(false);
                return;
            }
            try {
                const studentSnap = await getDoc(doc(db, "students", rollNo));
                if (studentSnap.exists() && studentSnap.data().password === password) {
                    currentUser = { rollNo: studentSnap.id, ...studentSnap.data() };
                    localStorage.setItem('loggedInStudentRollNo', currentUser.rollNo);
                    showApp();
                } else {
                    dom.loginError.textContent = 'Invalid Roll No. or Password.';
                }
            } catch (err) {
                dom.loginError.textContent = 'An error occurred. Check connection.';
            } finally {
                setLoginButtonLoading(false);
            }
        });
        dom.logoutBtn.addEventListener('click', showLogin);
        dom.forgotPasswordLink.addEventListener('click', () => { alert('Please contact the library administration to reset your password.'); });
        
        function showPage(pageId) {
            Object.values(pages).forEach(p => p.classList.add('hidden'));
            pages.main.classList.remove('hidden');
            if (pages[pageId]) {
                 pages[pageId].classList.remove('hidden');
            }
            Object.values(navItems).forEach(n => n.classList.remove('active'));
            if(navItems[pageId]) navItems[pageId].classList.add('active');
            switch(pageId) {
                case 'library': if (!listeners.library) listenForLibraryData(); break;
                case 'wishlist': if (!listeners.wishlist) listenForWishlistData(); else renderWishlistPage(); break;
                case 'demands': if (!listeners.demands) listenForDemandsData(); else renderDemandsPage(); break;
                case 'academics': break;
                case 'research': if(!listeners.research) listenForResearchPapers(); else renderResearchPapers(dom.researchSearchInput.value); break;
                case 'qpapers': populateYearFilter(); filterQpapersBtn.click(); break;
                case 'history': if (!listeners.history) listenForHistoryData(); else renderHistoryPage(); break;
                case 'profile': renderProfile(); break;
            }
        }
        Object.keys(navItems).forEach(id => navItems[id].addEventListener('click', () => showPage(id)));

        // --- Data Listeners ---
        function listenForLibraryData() {
            if (!db || listeners.library) return;
            dom.libraryContent.innerHTML = `<div class="flex justify-center items-center py-20"><div class="spinner animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>`;
            const shelvesUnsubscribe = onSnapshot(collection(db, "shelves"), s => { allShelves = s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b)=>a.name.localeCompare(b.name)); if(pages.library.offsetParent) renderShelfList(); }, e => console.error("Shelves listener failed:", e));
            const booksUnsubscribe = onSnapshot(collection(db, "books"), s => { allBooks = s.docs.map(d=>({id:d.id,...d.data()})); if(pages.library.offsetParent) renderShelfList(); }, e => console.error("Books listener failed:", e));
            listeners.library = () => { shelvesUnsubscribe(); booksUnsubscribe(); };
        }
        function listenForWishlistData() {
            if (!db || listeners.wishlist || !currentUser) return;
            dom.wishlistContent.innerHTML = `<div class="flex justify-center items-center py-20"><div class="spinner animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>`;
            listeners.wishlist = onSnapshot(collection(db, "wishlists", currentUser.rollNo, "books"), s => { myWishlistBooks = s.docs.map(d=>d.data()); if(pages.wishlist.offsetParent) renderWishlistPage(); });
        }
        function listenForDemandsData() {
            if (!db || listeners.demands) return;
            dom.demandsContent.innerHTML = `<div class="flex justify-center items-center py-20"><div class="spinner animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>`;
            listeners.demands = onSnapshot(collection(db, "demands"), s => { allDemands = s.docs.map(d=>({id:d.id,...d.data()})); if(pages.demands.offsetParent) renderDemandsPage(); });
        }
        function listenForHistoryData() {
            if (!db || listeners.history || !currentUser) return;
            dom.historyContent.innerHTML = `<div class="flex justify-center items-center py-20"><div class="spinner animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>`;
            const q = query(collection(db, "borrowingHistory"), where("studentRollNo", "==", currentUser.rollNo), orderBy("issuedDate", "desc"));
            listeners.history = onSnapshot(q, snapshot => {
                myHistory = snapshot.docs.map(doc => doc.data());
                if (pages.history.offsetParent) renderHistoryPage();
            }, e => console.error("History listener failed:", e));
        }

        // --- Page Rendering Functions ---
        function renderShelfList() {
            dom.libraryContent.innerHTML = '';
            dom.pageTitle.innerHTML = `<svg class="h-6 w-6 mr-2 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg> Library Shelves`;
            dom.libraryContent.dataset.viewing = 'shelves';
            if (allShelves.length === 0) { dom.libraryContent.innerHTML = `<p class="text-center text-gray-500 py-10">No shelves found.</p>`; return; }
            const shelfListContainer = document.createElement('div');
            shelfListContainer.className = 'space-y-3';
            allShelves.forEach(shelf => {
                const shelfCard = document.createElement('div');
                shelfCard.className = 'card bg-white rounded-lg p-4 flex justify-between items-center cursor-pointer';
                shelfCard.innerHTML = `<h3 class="font-semibold text-gray-800">${shelf.name}</h3><svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>`;
                shelfCard.addEventListener('click', () => renderBooksForShelf(shelf.id));
                shelfListContainer.appendChild(shelfCard);
            });
            dom.libraryContent.appendChild(shelfListContainer);
        }
        function renderBooksForShelf(shelfId) {
            const shelf = allShelves.find(s => s.id === shelfId);
            const booksOnShelf = allBooks.filter(b => b.shelfId === shelfId);
            dom.libraryContent.innerHTML = '';
            dom.libraryContent.dataset.viewing = 'books';
            const backButton = document.createElement('button');
            backButton.className = 'text-indigo-600 font-semibold mb-4 flex items-center';
            backButton.innerHTML = `<svg class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg> Back to Shelves`;
            backButton.addEventListener('click', () => { dom.searchInput.value = ''; renderShelfList(); });
            dom.libraryContent.appendChild(backButton);
            dom.pageTitle.innerText = shelf.name;
            const bookGrid = document.createElement('div');
            bookGrid.className = 'grid grid-cols-2 md:grid-cols-3 gap-4';
            if (booksOnShelf.length > 0) { booksOnShelf.forEach(book => bookGrid.appendChild(createBookCard(book))); } 
            else { bookGrid.innerHTML = `<p class="text-gray-500 col-span-full text-center">No books found on this shelf.</p>`; }
            dom.libraryContent.appendChild(bookGrid);
        }
        function renderWishlistPage() {
            dom.wishlistContent.innerHTML = '';
            if (myWishlistBooks.length === 0) { dom.wishlistContent.innerHTML = `<p class="text-center text-gray-500 py-10">Your wishlist is empty.</p>`; return; }
            const bookGrid = document.createElement('div');
            bookGrid.className = 'grid grid-cols-2 md:grid-cols-3 gap-4';
            myWishlistBooks.forEach(book => bookGrid.appendChild(createBookCard(book)));
            dom.wishlistContent.appendChild(bookGrid);
        }
        function renderDemandsPage() {
            dom.demandsContent.innerHTML = '';
            allDemands.sort((a, b) => (b.votes || 0) - (a.votes || 0));
            allDemands.forEach(demand => {
                const hasVoted = demand.voters && demand.voters.includes(currentUser.rollNo);
                const card = document.createElement('div');
                card.className = 'card bg-white rounded-lg p-4 flex justify-between items-center';
                card.innerHTML = `<div><p class="font-semibold">${demand.title}</p><p class="text-sm text-gray-500">by ${demand.author}</p></div><button class="vote-btn border rounded-lg px-3 py-1 text-sm font-semibold flex items-center gap-2 ${hasVoted ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700'}" data-id="${demand.id}" ${hasVoted ? 'disabled' : ''}><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" /></svg><span>${demand.votes || 0}</span></button>`;
                card.querySelector('.vote-btn').addEventListener('click', e => { e.stopPropagation(); voteForDemand(demand.id); });
                dom.demandsContent.appendChild(card);
            });
        }
        function renderHistoryPage() {
            dom.historyContent.innerHTML = '';
            const currentlyBorrowed = myHistory.filter(item => item.status === 'borrowed');
            const returnedHistory = myHistory.filter(item => item.status === 'returned');
            let currentHtml = `<div><h2 class="text-xl font-semibold mb-3">Currently Borrowed</h2>`;
            if (currentlyBorrowed.length === 0) { currentHtml += `<div class="bg-white rounded-lg p-4 text-center text-gray-500 shadow">You have no books checked out.</div>`; } 
            else { currentHtml += `<div class="space-y-3">${currentlyBorrowed.map(createHistoryCard).join('')}</div>`; }
            currentHtml += `</div>`;
            let returnedHtml = `<div><h2 class="text-xl font-semibold mb-3">Returned Books</h2>`;
            if (returnedHistory.length === 0) { returnedHtml += `<div class="bg-white rounded-lg p-4 text-center text-gray-500 shadow">Your borrowing history is empty.</div>`; } 
            else { returnedHtml += `<div class="space-y-3">${returnedHistory.map(createHistoryCard).join('')}</div>`; }
            returnedHtml += `</div>`;
            dom.historyContent.innerHTML = currentHtml + returnedHtml;
        }
        function renderProfile() {
            if (!currentUser) return;
            dom.profileName.textContent = currentUser.name || currentUser.rollNo;
            dom.profileRollNo.textContent = `Student ID: ${currentUser.rollNo}`;
            const placeholderAvatar = `https://placehold.co/100x100/E2E8F0/4A5568?text=${(currentUser.name || 'S').charAt(0)}`;
            const imageUrl = currentUser.profileImageUrl;
            if (imageUrl && (imageUrl.startsWith('http')) && !imageUrl.includes('google.com/search')) {
                dom.profileAvatar.src = imageUrl.replace('http://', 'https://');
            } else { dom.profileAvatar.src = placeholderAvatar; }
            if(currentUser.rollNo) { generateQRCode(); }
        }
        function renderSearchResults(books) {
            dom.libraryContent.innerHTML = '';
            dom.libraryContent.dataset.viewing = 'search';
            dom.pageTitle.innerHTML = `<svg class="h-6 w-6 mr-2 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg> Search Results`;
            const bookGrid = document.createElement('div');
            bookGrid.className = 'grid grid-cols-2 md:grid-cols-3 gap-4';
            if (books.length > 0) { books.forEach(book => bookGrid.appendChild(createBookCard(book))); }
             else { bookGrid.innerHTML = `<p class="text-gray-500 col-span-full text-center">No books found for your search.</p>`; }
            dom.libraryContent.appendChild(bookGrid);
        }

        // --- Helper Functions ---
        function createBookCard(book) {
            const placeholderIcon = `<svg class="h-10 w-10 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>`;
            const secureThumbnailUrl = book.thumbnailUrl ? book.thumbnailUrl.replace('http://', 'https://') : '';
            const thumbnailHTML = secureThumbnailUrl ? `<img src="${secureThumbnailUrl}" alt="${book.title}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center bg-gray-200">${placeholderIcon}</div>`;
            const bookCard = document.createElement('div');
            bookCard.className = 'card bg-white rounded-lg p-3 cursor-pointer';
            bookCard.setAttribute('data-book', JSON.stringify(book));
            bookCard.innerHTML = `<div class="bg-gray-200 h-32 rounded-md mb-2 overflow-hidden">${thumbnailHTML}</div><h3 class="font-semibold text-sm text-gray-800 truncate">${book.title}</h3><p class="text-xs text-gray-500 truncate">${book.author}</p>`;
            return bookCard;
        }
        function createHistoryCard(historyItem) {
            const placeholderIcon = `<div class="w-full h-full flex items-center justify-center bg-gray-200 rounded-md"><svg class="h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg></div>`;
            const secureThumbnailUrl = historyItem.thumbnailUrl ? historyItem.thumbnailUrl.replace('http://', 'https://') : '';
            const thumbnailHTML = secureThumbnailUrl ? `<img src="${secureThumbnailUrl}" class="w-12 h-16 object-cover rounded-md shadow-sm">` : `<div class="w-12 h-16">${placeholderIcon}</div>`;
            let dateText = '';
            if (historyItem.status === 'borrowed' && historyItem.dueDate) {
                const dueDate = new Date(historyItem.dueDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const isOverdue = dueDate < today;
                const dateString = dueDate.toLocaleDateString();
                if (isOverdue) {
                    dateText = `<p class="text-xs font-semibold text-red-600">Overdue! Due on: ${dateString}</p>`;
                } else { dateText = `<p class="text-xs text-gray-500">Due on: ${dateString}</p>`; }
            } else if (historyItem.returnDate) {
                const returnDateString = new Date(historyItem.returnDate).toLocaleDateString();
                dateText = `<p class="text-xs text-gray-500">Returned on: ${returnDateString}</p>`;
            }
            return `<div class="card bg-white rounded-lg p-3 flex items-center space-x-4">${thumbnailHTML}<div class="flex-1"><p class="font-semibold text-gray-800">${historyItem.bookTitle}</p>${dateText}</div></div>`;
        }
        function generateQRCode() {
            if(!currentUser || !currentUser.rollNo) return;
            QRCode.toCanvas(dom.qrCodeCanvas, currentUser.rollNo, { width: 160 }, function (error) { 
                if (error) console.error(error);
            });
        }
        function showToast(message, isError = false) {
            dom.toast.textContent = message;
            dom.toast.className = `fixed top-5 right-5 text-white px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 z-50 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            dom.toast.classList.remove('opacity-0');
            setTimeout(() => { dom.toast.classList.add('opacity-0'); }, 3000);
        }

        // --- Event Handlers & Actions ---
        const contentAreas = [dom.libraryContent, dom.wishlistContent];
        contentAreas.forEach(area => {
            area.addEventListener('click', (e) => {
                const card = e.target.closest('.card');
                if (card && card.hasAttribute('data-book')) {
                    const bookData = JSON.parse(card.getAttribute('data-book'));
                    showModal(bookData); 
                }
            });
        });
        dom.searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            if (!searchTerm) { renderShelfList(); return; }
            const filteredBooks = allBooks.filter(book => book.title.toLowerCase().includes(searchTerm) || book.author.toLowerCase().includes(searchTerm));
            renderSearchResults(filteredBooks);
        });
        async function toggleWishlist(book) {
            if (!currentUser) return;
            const wishlistRef = doc(db, "wishlists", currentUser.rollNo, "books", book.id);
            const isWishlisted = myWishlistBooks.some(item => item.id === book.id);
            try {
                if (isWishlisted) { await deleteDoc(wishlistRef); showToast('Removed from Wishlist'); } 
                else { await setDoc(wishlistRef, book); showToast('Added to Wishlist'); }
            } catch (error) { console.error(error); showToast('Could not update wishlist.', true); }
        }
        async function voteForDemand(demandId) {
            if (!currentUser) return;
            const demandRef = doc(db, "demands", demandId);
            try {
                const demand = allDemands.find(d => d.id === demandId);
                const voters = demand.voters || [];
                await updateDoc(demandRef, { votes: increment(1), voters: [...voters, currentUser.rollNo] });
                showToast('Vote counted!');
            } catch(e) { console.error("Error voting: ", e); showToast('Could not count vote.', true); }
        }
        dom.demandSubmitBtn.addEventListener('click', async () => {
            const title = dom.demandTitleInput.value.trim();
            const author = dom.demandAuthorInput.value.trim();
            if (!title || !author) { showToast('Please enter both title and author.', true); return; }
            try {
                const demandRef = doc(collection(db, "demands"));
                await setDoc(demandRef, { title, author, votes: 1, voters: [currentUser.rollNo], id: demandRef.id });
                dom.demandTitleInput.value = ''; dom.demandAuthorInput.value = '';
                showToast('Demand submitted successfully!');
            } catch(e) { console.error("Error submitting demand: ", e); showToast('Could not submit demand.', true); }
        });
        dom.changePasswordBtn.addEventListener('click', async () => {
            const currentPassword = dom.currentPasswordInput.value;
            const newPassword = dom.newPasswordInput.value;
            dom.passwordChangeStatus.textContent = '';
            if (!currentPassword || !newPassword) {
                dom.passwordChangeStatus.className = 'text-red-500 text-sm mt-2 text-center h-4';
                dom.passwordChangeStatus.textContent = 'Please fill both fields.';
                return;
            }
            if (currentPassword !== currentUser.password) {
                dom.passwordChangeStatus.className = 'text-red-500 text-sm mt-2 text-center h-4';
                dom.passwordChangeStatus.textContent = 'Incorrect current password.';
                return;
            }
            try {
                const studentRef = doc(db, "students", currentUser.rollNo);
                await updateDoc(studentRef, { password: newPassword });
                currentUser.password = newPassword;
                dom.passwordChangeStatus.className = 'text-green-500 text-sm mt-2 text-center h-4';
                dom.passwordChangeStatus.textContent = 'Password updated successfully!';
                dom.currentPasswordInput.value = '';
                dom.newPasswordInput.value = '';
            } catch (error) {
                console.error("Error updating password: ", error);
                dom.passwordChangeStatus.className = 'text-red-500 text-sm mt-2 text-center h-4';
                dom.passwordChangeStatus.textContent = 'An error occurred.';
            }
        });

        // --- Modal & Reviews ---
        function closeModal() { dom.modal.classList.add('opacity-0', 'pointer-events-none'); }
        dom.closeModalBtn.addEventListener('click', closeModal);
        dom.modal.addEventListener('click', e => { if (e.target === dom.modal) closeModal(); });
        async function showModal(book) {
            currentOpenBookId = book.id;
            const secureThumbnailUrl = book.thumbnailUrl ? book.thumbnailUrl.replace('http://', 'https://') : '';
            if (secureThumbnailUrl) { dom.modalThumbnail.src = secureThumbnailUrl; dom.modalThumbnail.style.display = 'block'; } else { dom.modalThumbnail.style.display = 'none'; }
            dom.modalTitle.innerText = book.title;
            dom.modalAuthor.innerText = `by ${book.author}`;
            const statusEl = dom.modalStatus;
            const statusText = book.status.charAt(0).toUpperCase() + book.status.slice(1);
            statusEl.innerText = statusText;
            statusEl.className = `text-sm font-semibold mb-4 inline-block px-3 py-1 rounded-full ${book.status === 'available' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`;
            const isWishlisted = myWishlistBooks.some(item => item.id === book.id);
            dom.wishlistBtn.textContent = isWishlisted ? 'Remove from Wishlist' : 'Add to Wishlist';
            dom.wishlistBtn.className = `w-full font-bold py-2 rounded-lg mt-4 transition ${isWishlisted ? 'bg-gray-200 text-gray-800' : 'bg-pink-500 text-white'}`;
            dom.wishlistBtn.onclick = () => toggleWishlist(book);
            await renderAverageRating(book.id);
            await renderReviews(book.id);
            initializeStarRatingInput();
            dom.modal.classList.remove('opacity-0', 'pointer-events-none');
        }
        async function renderAverageRating(bookId) {
            const bookRef = doc(db, "books", bookId);
            const bookSnap = await getDoc(bookRef);
            if (!bookSnap.exists()) return;
            const bookData = bookSnap.data();
            const avgRating = bookData.averageRating || 0;
            const reviewCount = bookData.reviewCount || 0;
            const starsHTML = generateStarsHTML(avgRating);
            dom.modalAvgRating.innerHTML = `${starsHTML} <span class="ml-2">(${reviewCount} reviews)</span>`;
        }
        async function renderReviews(bookId) {
            dom.modalReviewsList.innerHTML = `<p class="text-gray-500">Loading reviews...</p>`;
            const reviewsQuery = query(collection(db, `books/${bookId}/reviews`), orderBy('timestamp', 'desc'));
            const querySnapshot = await getDocs(reviewsQuery);
            if (querySnapshot.empty) {
                dom.modalReviewsList.innerHTML = `<p class="text-gray-500">No reviews yet. Be the first!</p>`;
                return;
            }
            dom.modalReviewsList.innerHTML = '';
            querySnapshot.forEach(doc => {
                const review = doc.data();
                const reviewEl = document.createElement('div');
                reviewEl.className = 'border-t pt-3';
                reviewEl.innerHTML = `<div class="flex items-center mb-1">${generateStarsHTML(review.rating)}<p class="ml-2 font-semibold text-sm">${review.studentName || 'Anonymous'}</p></div><p class="text-gray-600 text-sm">${review.comment}</p>`;
                dom.modalReviewsList.appendChild(reviewEl);
            });
        }
        function initializeStarRatingInput() {
            const starRatingContainer = dom.addReviewForm.querySelector('.star-rating');
            starRatingContainer.innerHTML = '';
            starRatingContainer.dataset.rating = 0;
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('span');
                star.innerHTML = `<svg class="w-6 h-6 star-empty" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
                star.dataset.value = i;
                starRatingContainer.appendChild(star);
            }
            starRatingContainer.addEventListener('click', e => {
                const star = e.target.closest('span');
                if (!star) return;
                const rating = star.dataset.value;
                starRatingContainer.dataset.rating = rating;
                updateStarDisplay(starRatingContainer, rating);
            });
        }
        function updateStarDisplay(container, rating) {
            const stars = container.querySelectorAll('span');
            stars.forEach(star => {
                const starValue = parseInt(star.dataset.value);
                const svg = star.querySelector('svg');
                svg.classList.toggle('star-filled', starValue <= rating);
                svg.classList.toggle('star-empty', starValue > rating);
            });
        }
        function generateStarsHTML(rating) {
            let html = '<div class="flex items-center">';
            for (let i = 1; i <= 5; i++) {
                const starClass = i <= Math.round(rating) ? 'star-filled' : 'star-empty';
                html += `<svg class="w-5 h-5 ${starClass}" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
            }
            html += '</div>';
            return html;
        }
        dom.submitReviewBtn.addEventListener('click', async () => {
            if (!currentUser || !currentOpenBookId) return;
            const starRatingContainer = dom.addReviewForm.querySelector('.star-rating');
            const rating = parseInt(starRatingContainer.dataset.rating);
            const comment = dom.reviewComment.value.trim();
            dom.reviewError.textContent = '';
            if (rating === 0) { dom.reviewError.textContent = 'Please select a star rating.'; return; }
            if (!comment) { dom.reviewError.textContent = 'Please enter a comment.'; return; }
            dom.submitReviewBtn.disabled = true;
            dom.submitReviewBtn.textContent = 'Submitting...';
            try {
                const reviewRef = doc(collection(db, `books/${currentOpenBookId}/reviews`));
                await setDoc(reviewRef, { rating, comment, studentId: currentUser.rollNo, studentName: currentUser.name, timestamp: serverTimestamp() });
                const bookRef = doc(db, "books", currentOpenBookId);
                const reviewsSnap = await getDocs(collection(db, `books/${currentOpenBookId}/reviews`));
                const reviewCount = reviewsSnap.size;
                const totalRating = reviewsSnap.docs.reduce((sum, doc) => sum + doc.data().rating, 0);
                const averageRating = totalRating / reviewCount;
                await updateDoc(bookRef, { reviewCount, averageRating });
                await renderReviews(currentOpenBookId);
                await renderAverageRating(currentOpenBookId);
                dom.reviewComment.value = '';
                starRatingContainer.dataset.rating = 0;
                updateStarDisplay(starRatingContainer, 0);
                showToast('Review submitted successfully!');
            } catch (error) {
                console.error("Error submitting review:", error);
                dom.reviewError.textContent = 'Could not submit review.';
            } finally {
                dom.submitReviewBtn.disabled = false;
                dom.submitReviewBtn.textContent = 'Submit Review';
            }
        });

        // --- Academic Resources ---
        function listenForResearchPapers() {
            if (!currentUser) { dom.researchContent.innerHTML = `<div class="text-center py-10"><p class="text-gray-600 mb-4">You must be logged in to view research papers.</p></div>`; return; }
            if (!currentUser.canAccessResearch) { dom.researchContent.innerHTML = `<div class="text-center py-10"><h3 class="text-xl font-semibold">Access Denied</h3><p class="text-gray-600 mt-2">You are not authorized to view research papers.</p></div>`; return; }
            dom.researchContent.innerHTML = `<div class="flex justify-center items-center py-20"><div class="spinner animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div></div>`;
            listeners.research = onSnapshot(query(collection(db, "researchPapers"), orderBy('uploadedAt', 'desc')), (snapshot) => {
                allResearchPapers = snapshot.docs.map(doc => doc.data());
                renderResearchPapers();
            });
        }
        function renderResearchPapers(searchTerm = '') {
            const filteredPapers = searchTerm ? allResearchPapers.filter(p => p.title.toLowerCase().includes(searchTerm) || p.author.toLowerCase().includes(searchTerm)) : allResearchPapers;
            if (filteredPapers.length === 0) {
                dom.researchContent.innerHTML = `<p class="text-center text-gray-500 py-10">${searchTerm ? 'No papers found.' : 'No research papers uploaded.'}</p>`;
                return;
            }
            dom.researchContent.innerHTML = `<div class="space-y-3"></div>`;
            const container = dom.researchContent.firstElementChild;
            filteredPapers.forEach(paper => container.appendChild(createPaperCard(paper)));
        }
        dom.researchSearchInput.addEventListener('input', (e) => renderResearchPapers(e.target.value.toLowerCase()));
        function populateYearFilter() {
            const currentYear = new Date().getFullYear();
            if (dom.filterYear.options.length > 1) return;
            for(let i=0; i < 10; i++) {
                dom.filterYear.innerHTML += `<option>${currentYear - i}</option>`;
            }
        }
        filterQpapersBtn.addEventListener('click', async () => {
            let q = query(collection(db, "questionPapers"), orderBy('year', 'desc'));
            const department = dom.filterDepartment.value;
            const year = dom.filterYear.value;
            const semester = dom.filterSemester.value;
            if (department) q = query(q, where('department', '==', department));
            if (year) q = query(q, where('year', '==', parseInt(year)));
            if (semester) q = query(q, where('semester', '==', parseInt(semester)));
            dom.qpapersContent.innerHTML = `<div class="flex justify-center items-center py-10"><div class="spinner animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div></div>`;
            const querySnapshot = await getDocs(q);
            if(querySnapshot.empty) {
                dom.qpapersContent.innerHTML = `<p class="text-center text-gray-500 py-10">No question papers found.</p>`;
                return;
            }
            dom.qpapersContent.innerHTML = '';
            querySnapshot.forEach(doc => dom.qpapersContent.appendChild(createPaperCard(doc.data())));
        });
        function createPaperCard(paperData) {
            const card = document.createElement('a');
            card.href = paperData.downloadURL;
            card.target = "_blank";
            card.className = "card bg-white rounded-lg p-4 block hover:shadow-lg transition";
            let subtitle = paperData.author ? `<p class="text-sm text-gray-500">by ${paperData.author}</p>` : `<p class="text-sm text-gray-500">${paperData.department} | Year: ${paperData.year} | Sem: ${paperData.semester}</p>`;
            card.innerHTML = `<div class="flex items-center justify-between"><div><p class="font-semibold text-indigo-700">${paperData.title || paperData.courseName}</p>${subtitle}</div><svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></div>`;
            return card;
        }
        dom.academicsResearchCard.addEventListener('click', () => showPage('research'));
        dom.academicsQpapersCard.addEventListener('click', () => showPage('qpapers'));
        dom.backToAcademicsBtn1.addEventListener('click', () => showPage('academics'));
        dom.backToAcademicsBtn2.addEventListener('click', () => showPage('academics'));

    </script>
</body>
</html>

